#!/bin/bash -e

echo "Starting Sage-Network Watchdog"

#STEPS to be discussed
# 1.) Check for internet at all
if ! ping -q -c 1 -W 1 8.8.8.8 >/dev/null; then

  echo "Internet is down, restarting network services"
  systemctl restart NetworkManager
  systemctl restart ModemManager
  systemctl restart waggle-reverse-tunnel

fi

#2.) Check for connection to beehive
if ! [[ $(ss -tr state established | grep beehive:20022) ]]; then 

  rm -f /media/bl-rec/valid_media

  lastConnected=$(cat /etc/waggle/LAST_CONNECTION_TO_BEEHIVE)

  if [ $lastConnected -ge 48 ]; then
     echo "Haven't been connected to Beehive in more than 24 hours, not sure what to do, maybe shutdown wagman service"
     touch /media/bl-rec/fail_media
     
  elif [ $lastConnected -ge 6 ] && [ $lastConnected % 6 == 0 ] ; then
     echo "Haven't been connected to Beehive in a multiple of 3 hours, rebooting"
     systemctl --force reboot

  else	
     echo "No connection to beehive, trying to recover connection"
     systemctl restart waggle-reverse-tunnel
  fi

  ((lastConnected++))

else

  echo "Valid media device, Connected to Beehive Restarting Counter"
  echo 0 > /etc/waggle/LAST_CONNECTION_TO_BEEHIVE
  
  touch /media/bl-rec/valid_media
  rm -f /media/bl-rec/fail_media

fi


#3 Config Failures

#4 Hardware Failures

echo "Sage Network Watchdog Finished"
